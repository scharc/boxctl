#!/bin/bash
# Run Qwen Code with super agent settings (auto-approve mode)
#
# Qwen reads instructions from ~/.qwen/QWEN.md
# For super mode, we swap the symlink to include superagents.md content
#
# Required environment variables:
#   OPENAI_API_KEY - API key for OpenAI-compatible provider
#   OPENAI_BASE_URL - Base URL for OpenAI-compatible provider (optional)
#   QWEN_MODEL - Model to use (optional, defaults to qwen3-coder)

AGENTS_MD="/workspace/.boxctl/agents.md"
SUPER_MD="/workspace/.boxctl/superagents.md"
COMBINED="/tmp/boxctl-super-instructions.md"
QWEN_MD="${HOME}/.qwen/QWEN.md"

# Create combined instructions file
if [[ -f "${AGENTS_MD}" ]] && [[ -f "${SUPER_MD}" ]]; then
    cat "${AGENTS_MD}" "${SUPER_MD}" > "${COMBINED}"
    # Update symlink to point to combined file
    ln -sf "${COMBINED}" "${QWEN_MD}"
fi

# Export env var so MCP can also detect super mode
export BOXCTL_SUPER_MODE=true

# Load .env files if they exist (qwen-specific first, then general)
for envfile in ~/.qwen/.env ~/.env .env /workspace/.boxctl/.env; do
    # shellcheck source=/dev/null
    [[ -f "$envfile" ]] && source "$envfile"
done

if [[ -z "$OPENAI_API_KEY" ]]; then
    echo "Error: OPENAI_API_KEY not set" >&2
    echo "Add to ~/.qwen/.env, ~/.env, .env, or /workspace/.boxctl/.env" >&2
    exit 1
fi

exec qwen \
    --auth-type openai \
    --model "${QWEN_MODEL:-${OPENAI_MODEL:-qwen3-coder}}" \
    --yolo \
    "$@"
